<!-- Highlighted Pascal code generated by DelphiDabbler PasHi -->
<pre class="pas-source"><span class="pas-kwd">unit</span><span class="pas-space"> </span><span class="pas-ident">UDevice</span><span class="pas-sym">;</span>
<span class="pas-comment">// Demo-Device Unit f&#252;r IPS-Module</span>
<span class="pas-comment">// Thomas Dre&#223;ler 2009 - 2012</span>
<span class="pas-comment">// requires IPS V2.6+ (Property functions)</span>
<span class="pas-comment">// frei f&#252;r private Nutzung</span>

<span class="pas-kwd">interface</span>

<span class="pas-kwd">uses</span><span class="pas-space">  </span><span class="pas-ident">Windows</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">SysUtils</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Forms</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">StrUtils</span><span class="pas-sym">,</span><span class="pas-space">  </span><span class="pas-comment">//standard units f&#252;r eigene Implementierung</span>
<span class="pas-space">     </span><span class="pas-ident">UIPSTypes</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">UIPSModuleTypes</span><span class="pas-sym">,</span><span class="pas-ident">UIPSDataTypes</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-comment">//IPS SDK</span>
<span class="pas-space">     </span><span class="pas-ident">UModuleInterface</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//eigenes Interface</span>

<span class="pas-kwd">type</span>


<span class="pas-comment">//Hauptobjekt des Moduls, implementiert die folgenden Interfaces</span>
<span class="pas-ident">TIPSDevice</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">class</span><span class="pas-sym">(</span><span class="pas-ident">TIPSModuleObject</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-comment">//standard</span>
<span class="pas-space">                        </span><span class="pas-ident">IIPSModule</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-comment">//standard</span>
<span class="pas-space">                        </span><span class="pas-ident">IIPSReceiveString</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-comment">//TextEmpfang aus anderen Modulen erm&#246;glichen</span>
<span class="pas-space">                        </span><span class="pas-ident">IIPSDevice</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-comment">//eigenes Interface</span>

<span class="pas-space">  </span><span class="pas-kwd">private</span>
<span class="pas-space">   </span><span class="pas-comment">//--- Custom Objects</span>
<span class="pas-space">   </span><span class="pas-ident">lastLine</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-comment">//--- seperate get/set- property Funktionen  sind obsolete</span>

<span class="pas-space">   </span><span class="pas-comment">//--- Private Procedures/Functions</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">logme</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">DoEcho</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">handleData</span><span class="pas-sym">(</span><span class="pas-ident">from</span><span class="pas-sym">,</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">String</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-kwd">protected</span>
<span class="pas-space">  </span><span class="pas-comment">{Alle Funktionen, die auch in abgeleiteten Objekten genutzt werden sollen,</span>
<span class="pas-comment">  aber nicht &#246;ffentlich sind, werden als Protected gekennzeichnet</span>
<span class="pas-comment">  Funktionen, die nicht implementiert werden, m&#252;ssen auskommentiert werden</span>

<span class="pas-comment">   Beispiel:</span>
<span class="pas-comment">   IPS-funktionen zur optionalen Auswertung von Status-Informationen</span>
<span class="pas-comment">   //Wenn eine Instance den Status &#228;ndert, kann hiermit drauf reagiert werden</span>
<span class="pas-comment">   procedure ProcessInstanceStatusChange(InstanceID: TInstanceID; Status: Integer); override;</span>

<span class="pas-comment">   //Wenn der Kernel den Status &#228;ndern m&#246;chte, kann ebenfalls noch reagiert werden</span>
<span class="pas-comment">   procedure ProcessKernelRunlevelChange(Runlevel: Integer); override;</span>
<span class="pas-comment">   }</span>
<span class="pas-space">  </span><span class="pas-kwd">public</span>
<span class="pas-space">  </span><span class="pas-comment">{</span>
<span class="pas-comment">  Alle nach Aussen sichtbare Funktionen und Werte m&#252;ssen Public sein</span>

<span class="pas-comment">  1. Objekterstellung , muss immer implementiert werden und public sein</span>
<span class="pas-comment">  Dabei wird das Standardverhalten &#252;berschrieben (override)</span>
<span class="pas-comment">  mit inherited kann die Standardfunktionalit&#228;t trotzdem noch genutzt werden</span>
<span class="pas-comment">  }</span>
<span class="pas-space">  </span><span class="pas-kwd">constructor</span><span class="pas-space"> </span><span class="pas-ident">Create</span><span class="pas-sym">(</span><span class="pas-ident">IKernel</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">IIPSKernel</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-ident">InstanceID</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TInstanceID</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">destructor</span><span class="pas-space">  </span><span class="pas-ident">Destroy</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-comment">//2. Class Functions</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetModuleID</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUID</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetModuleType</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TIPSModuleType</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetModuleName</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">String</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetImplemented</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUIDs</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetVendor</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">String</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetAliases</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStringArray</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-comment">//3.optionale Funktionen</span>
<span class="pas-space">   </span><span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">GetParentRequirements</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUIDs</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//class function GetClientRequirements(): TStrGUIDs; override;</span>

<span class="pas-space">   </span><span class="pas-comment">//4. Interface Funktionen</span>
<span class="pas-space">   </span><span class="pas-comment">//--- IIPSModule implementation</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">LoadSettings</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">SaveSettings</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">ResetChanges</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">ApplyChanges</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>


<span class="pas-space">   </span><span class="pas-comment">//--- IIPSReceiveString implemenatation(Datapoint)</span>
<span class="pas-space">   </span><span class="pas-comment">//alle Interface-Funktionen m&#252;ssen stdcall benutzen!</span>
<span class="pas-space">   </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">ReceiveText</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-comment">//--- IIPSDevice implementation =diese Funktionen sind unter PHP sichtbar</span>
<span class="pas-space">  </span><span class="pas-comment">{alle im Interface genannten Funktionen m&#252;ssen Textgleich noch einmal</span>
<span class="pas-comment">  hier aufgef&#252;hrt werden</span>
<span class="pas-comment">  alle PHP-Funktionen m&#252;ssen stdcall benutzen!</span>
<span class="pas-comment">  }</span>
<span class="pas-space">  </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">setLogFile</span><span class="pas-sym">(</span><span class="pas-ident">FileName</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">setLine</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-ident">integer</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">getLine</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">EnableEcho</span><span class="pas-sym">(</span><span class="pas-ident">bEcho</span><span class="pas-sym">:</span><span class="pas-ident">boolean</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">Testfunction</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">implementation</span>


<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetModuleType</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TIPSModuleType</span><span class="pas-sym">;</span>
<span class="pas-comment">{</span>
<span class="pas-comment">definiert den Modultyp.</span>
<span class="pas-comment">Devices k&#246;nnen keine Childs, nur Parents haben, Splitter dagegen beides.</span>
<span class="pas-comment">Nur Devices werden bei der Modulauswahl angezeigt, wenn man nicht &quot;AlleModuleAnzeigen&quot;</span>
<span class="pas-comment">ausgew&#228;hlt hat.</span>
<span class="pas-comment">Regel:Wenn es ein Endger&#228;t ist, dann immer als Device, Wenn es dagegen Daten an andere</span>
<span class="pas-comment">Module senden soll, als Splitter definieren</span>
<span class="pas-comment">}</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">mtDevice</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//Typ ist i.d.R. mtDevice oder mtSplitter (siehe UIPSTypes)</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetModuleID</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUID</span><span class="pas-sym">;</span>
<span class="pas-comment">//gibt die GUID des Moduls f&#252;r die Modulverwaltung zur&#252;ck</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">IIPSDevice</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//Will return Interface GUID</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetModuleName</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">String</span><span class="pas-sym">;</span>
<span class="pas-comment">{</span>
<span class="pas-comment">gibt den Namen des Moduls f&#252;r die Modulverwaltung zur&#252;ck</span>
<span class="pas-comment">unter diesem Prefix z.B.die Eintr&#228;ge im Log vorgenommen und</span>
<span class="pas-comment">auch das Json File f&#252;r die Properties ben&#246;tigt exact diesen Namen</span>
<span class="pas-comment">}</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-str">'MyDemo'</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetParentRequirements</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUIDs</span><span class="pas-sym">;</span>
<span class="pas-comment">{</span>
<span class="pas-comment">abfrage, ob der Parent ein kompatibles Interface hat</span>
<span class="pas-comment">Hier wollen wir nur Parents mit TextInterface Senden</span>
<span class="pas-comment">Parents, die diese Vorraussetzung nicht haben, k&#246;nnen nicht verbunden werden</span>
<span class="pas-comment">}</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-ident">SetLength</span><span class="pas-sym">(</span><span class="pas-ident">Result</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-sym">[</span><span class="pas-num">0</span><span class="pas-sym">]</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">IIPSSendString</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetImplemented</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrGUIDs</span><span class="pas-sym">;</span>
<span class="pas-comment">{{</span>
<span class="pas-comment">hhier erf&#228;hrt der Parent mittels GetParentRequirement</span>
<span class="pas-comment">((bzw der Child &#252;ber getChildRequirements),</span>
<span class="pas-comment">oob er kompatibel mit diesem modul ist, sprich das gew&#252;nschte Interface implementiert ist</span>
<span class="pas-comment">HHier sagen wir, das wir &#252;ber das TextInterface daten bekommen k&#246;nnen</span>
<span class="pas-comment">}</span><span class="pas-err">}</span>
<span class="pas-ident">bbegin</span>
<span class="pas-space">  </span><span class="pas-ident">SetLength</span><span class="pas-sym">(</span><span class="pas-ident">Result</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-sym">[</span><span class="pas-num">0</span><span class="pas-sym">]</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">IIPSReceiveString</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetVendor</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">String</span><span class="pas-sym">;</span>
<span class="pas-comment">//Das Modul erscheint unter diesem Herstellernamen in der Auswahl</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-str">'MySelf'</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">class</span><span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">GetAliases</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStringArray</span><span class="pas-sym">;</span>
<span class="pas-comment">//Das Modul erscheint unter allen diesen Bamen in der Auswahl</span>
<span class="pas-kwd">begin</span>

<span class="pas-space"> </span><span class="pas-ident">SetLength</span><span class="pas-sym">(</span><span class="pas-ident">Result</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">2</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//Anzahl der Namen entsprechend anpassen</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-sym">[</span><span class="pas-num">0</span><span class="pas-sym">]</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-str">'MyDevice'</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">Result</span><span class="pas-sym">[</span><span class="pas-num">1</span><span class="pas-sym">]</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-str">'MyLogger'</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//optional</span>

<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//Ab hier gehts in eingemachte</span>
<span class="pas-comment">//Implementation des Hauptobktes und der Interface</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">constructor</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">Create</span><span class="pas-sym">(</span><span class="pas-ident">IKernel</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">IIPSKernel</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-ident">InstanceID</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TInstanceID</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-kwd">begin</span>

<span class="pas-space"> </span><span class="pas-comment">{StandardRoutinen zur Objekterzeugung eines IPS-Modules ausf&#252;hren</span>
<span class="pas-comment"> }</span>
<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Create Object ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">{Properties definieren</span>
<span class="pas-comment"> Diese Properties werden &#252;ber IPS_SetProperty und IPS_SetProperty-Funktionen</span>
<span class="pas-comment"> gesetzt bzw. Ausgelesen werden. Der Name ist egal, wird aber in den Funktionen</span>
<span class="pas-comment"> ben&#246;tigt,der 2. Parameter ist ein default Wert</span>

<span class="pas-comment"> Die Namen der Properties k&#246;nnen in einem json File im /forms Ordner</span>
<span class="pas-comment"> referenziert und damit die Instanz konfiguriert werden</span>

<span class="pas-comment"> }</span>
<span class="pas-space"> </span><span class="pas-ident">RegisterProperty</span><span class="pas-sym">(</span><span class="pas-space"> </span><span class="pas-str">'LogFile'</span><span class="pas-sym">,</span><span class="pas-str">''</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">RegisterProperty</span><span class="pas-sym">(</span><span class="pas-space"> </span><span class="pas-str">'Echo'</span><span class="pas-sym">,</span><span class="pas-ident">false</span><span class="pas-sym">)</span><span class="pas-sym">;</span>


<span class="pas-space"> </span><span class="pas-comment">{Status-Variablen definieren (optional)</span>
<span class="pas-comment"> Diese StatusVariablen werden dann in der Konsole und Frontend automatisch angezeigt</span>
<span class="pas-comment"> Die StatusVariablen sollten auch ein profil bekommen, wenn sie in der Anzeige</span>
<span class="pas-comment"> formatiert dargestellt werden sollen. Details bitte dem SDK (UIPSTypes ab</span>
<span class="pas-comment"> Zeile 1925 f&#252;r SDK 2.04) entnehmen. Im WebFrontend sind in 2.0.4 aber nur die</span>
<span class="pas-comment"> DefaultProfile implementiert, so das man bei eigenen Profile diese dort</span>
<span class="pas-comment"> selber nachbilden muss.</span>
<span class="pas-comment"> In 2.10 gibt man den Namen eines existierenden Defaultprofiles oder eines eigenen Profiles mit,</span>
<span class="pas-comment"> welches man vorher mit CreateXXXXProfile angelegt hat. Bei eigenen Profilen kann man auch ein eigenes Icon</span>
<span class="pas-comment"> angeben oder man w&#228;hlt ein existierendes aus, wie hier.</span>
<span class="pas-comment"> ab SDK2.5 werden hier nur statische Variablen eingetragen</span>
<span class="pas-comment"> }</span>
<span class="pas-space"> </span><span class="pas-ident">TIPSVarProfile</span><span class="pas-sym">.</span><span class="pas-ident">CreateStringProfile</span><span class="pas-sym">(</span><span class="pas-str">'DemoTextProfile'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'Information'</span><span class="pas-sym">,</span><span class="pas-str">''</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'--&gt;logged'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">RegisterVariable</span><span class="pas-sym">(</span><span class="pas-str">'LastLineVariable'</span><span class="pas-sym">,</span><span class="pas-str">'LastText'</span><span class="pas-sym">,</span><span class="pas-ident">vtString</span><span class="pas-sym">,</span><span class="pas-str">'DemoTextProfile'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">RegisterVariable</span><span class="pas-sym">(</span><span class="pas-str">'TestVariable'</span><span class="pas-sym">,</span><span class="pas-str">'Test'</span><span class="pas-sym">,</span><span class="pas-ident">vtString</span><span class="pas-sym">,</span><span class="pas-str">'DemoTextProfile'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//Beispiel f&#252;r einen Schalter mit default Profile</span>
<span class="pas-space"> </span><span class="pas-comment">//RegisterVariable('StatusVariable','Status',vtBoolean,GetDefaultProfile(dpSwitch));</span>

<span class="pas-space"> </span><span class="pas-comment">//Initialisation lokaler variablen</span>
<span class="pas-space"> </span><span class="pas-ident">lastLine</span><span class="pas-sym">:=</span><span class="pas-str">''</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-comment">//Hier werden auch Timer usw. initialisiert</span>
<span class="pas-space"> </span><span class="pas-comment">//...</span>

<span class="pas-space"> </span><span class="pas-comment">//Check Parent</span>
<span class="pas-space"> </span><span class="pas-comment">{hier wird automatisch die Verbindung zu einem passenden Parent hergestellt.</span>
<span class="pas-comment"> steht der Parameter auf True, wird der Parent immer neu angelegt</span>
<span class="pas-comment"> Die automatische Auswahl bei noch nicht registriertem Parent greift leider</span>
<span class="pas-comment"> manchmal daneben, weil immer das erste passende Modul zugewiesen wird.</span>
<span class="pas-comment"> auch wenn es schon woanders zugewiesen wurde.</span>
<span class="pas-comment"> }</span>
<span class="pas-space"> </span><span class="pas-ident">RequireParent</span><span class="pas-sym">(</span><span class="pas-ident">IIPSSendString</span><span class="pas-sym">,</span><span class="pas-ident">false</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">destructor</span><span class="pas-space">  </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">Destroy</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Destroy Object ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>

<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//--Implementation Klassenfunktionen</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">LoadSettings</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-comment">{holt aus den gespeicherten Settings Properties und Variablen-Namen/Werte</span>
<span class="pas-comment">Wurde diese vorher nicht mit Register... definiert, gibt es Fehler im Logfile</span>
<span class="pas-comment">}</span>

<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Load Settings ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-comment">{hier kann man noch zus&#228;tzliche Einstellungen  dazu laden.</span>
<span class="pas-comment"> oder z.B. die wieder hergestellten gespeicherten Werte noch einmal</span>
<span class="pas-comment"> bearbeiten, Status zur&#252;cksetzen.</span>
<span class="pas-comment"> Die Ausf&#252;hrung von Aktionen ist noch nicht m&#246;glich</span>
<span class="pas-comment"> }</span>
<span class="pas-space"> </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">SaveSettings</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-comment">{Speichert Properties und StrausVariablen in die Settings.xml}</span>

<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Save Settings ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">ResetChanges</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-comment">{macht die im speicher vorhandenen &#196;nderungen wieder R&#252;ckg&#228;nig.</span>
<span class="pas-comment">Dabei wird lediglich der Settings Record umkopiert. i.D.R arbeitet man jedoch</span>
<span class="pas-comment">mit dem aktuellen (ungespeicherten) changedsettings record}</span>
<span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Reset Settings ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">ApplyChanges</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-comment">{hier werden die dynamische StatusVariablen zugewiesen und am Ende ein</span>
<span class="pas-comment">SaveSettings ausgef&#252;hrt</span>
<span class="pas-comment">im Beispiel soll die Variable Beispiel der Batterie nur auftauchen,</span>
<span class="pas-comment">wenn das Device wirklich eine Batterie hat</span>
<span class="pas-comment">}</span>
<span class="pas-comment">//MaintainVariable(haveBattery,'BatteryVariable', 'Battery', vtBoolean, 'Battery.Reversed');</span>
<span class="pas-kwd">begin</span>

<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Apply Changes ...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">{</span>
<span class="pas-comment"> hier k&#246;nnten jetzt noch Zusatzfunktionen zur Einstellung des Parents stehen</span>
<span class="pas-comment"> ...</span>

<span class="pas-comment"> Die Initialisierung des Moduls ist nun abgeschlossen.</span>
<span class="pas-comment"> }</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>


<span class="pas-comment">//Datapoint</span>
<span class="pas-comment">{Implementation Dateninterface IIPSReceiveString</span>
<span class="pas-comment">IIPSReceiveString erfordert die Implementierung einer Funktion ReceiveText</span>
<span class="pas-comment">mit einem String als Parameter</span>
<span class="pas-comment">}</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">ReceiveText</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>

<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'External Data received'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space">  </span><span class="pas-ident">SendData</span><span class="pas-sym">(</span><span class="pas-str">'Received'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">' Msg:'</span><span class="pas-sym">+</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-comment">//Ausf&#252;hrung der Datenbearbeitung</span>
<span class="pas-space">  </span><span class="pas-ident">handleData</span><span class="pas-sym">(</span><span class="pas-str">'Interface'</span><span class="pas-sym">,</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//---Implementation IIPSDevice Modulfunctionen (Actions)</span>
<span class="pas-comment">{Alle im DeviceInterface definierten Funktionen und Proceduren m&#252;ssen auch</span>
<span class="pas-comment">implementiert werden.</span>
<span class="pas-comment">}</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-comment">//PHP-DemoFunktion zum setzen des Logfilenamens</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">setLogFile</span><span class="pas-sym">(</span><span class="pas-ident">FileName</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">begin</span>
<span class="pas-space">   </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Set Logfile entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space">   </span><span class="pas-ident">SendData</span><span class="pas-sym">(</span><span class="pas-str">'SetLogfile'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">' SetLogFile to '</span><span class="pas-sym">+</span><span class="pas-ident">FileName</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//hier wird einfach nur die SetMethode aufgerufen</span>
<span class="pas-space">    </span><span class="pas-ident">SetProperty</span><span class="pas-sym">(</span><span class="pas-str">'LogFile'</span><span class="pas-sym">,</span><span class="pas-ident">FileName</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//ablegen</span>

<span class="pas-space">    </span><span class="pas-comment">{setzt ein Flag zum Speichern und</span>
<span class="pas-comment">    erzeugt eine SettingsChanged-Message}</span>
<span class="pas-space">    </span><span class="pas-ident">settingschanged</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-space"> </span><span class="pas-comment">//PHP-DemoFunktion zur R&#252;ckgabe eines Wertes</span>
<span class="pas-space"> </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">getLine</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space"> </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'GetLine entered...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space"> </span><span class="pas-ident">SendData</span><span class="pas-sym">(</span><span class="pas-str">'getLine'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//Als Ergenis wird der zuletzt gespeicherte Text zur&#252;ckgegeben</span>
<span class="pas-space"> </span><span class="pas-ident">result</span><span class="pas-sym">:=</span><span class="pas-ident">lastLine</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">SendData</span><span class="pas-sym">(</span><span class="pas-str">'getLine'</span><span class="pas-sym">,</span><span class="pas-str">'Finshed, Result:'</span><span class="pas-sym">+</span><span class="pas-ident">result</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-comment">//PHP-DemoFun zum ausf&#252;hren einer Aktion und R&#252;ckgabe eines Wertes</span>
<span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">setLine</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-ident">integer</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'SetLine entered...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space">   </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'setLine'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//Ausf&#252;hrung einer Logik-Funktion</span>
<span class="pas-space">   </span><span class="pas-ident">handleData</span><span class="pas-sym">(</span><span class="pas-str">'PHP'</span><span class="pas-sym">,</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//R&#252;ckgabe eines Wertes</span>
<span class="pas-space">   </span><span class="pas-ident">Result</span><span class="pas-sym">:=</span><span class="pas-ident">length</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-comment">//---PHP Stub zum setzen einer Property</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">EnableEcho</span><span class="pas-sym">(</span><span class="pas-ident">bEcho</span><span class="pas-sym">:</span><span class="pas-ident">boolean</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Enable Echo entered...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space">   </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'Enable Echo'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-ident">SetProperty</span><span class="pas-sym">(</span><span class="pas-str">'Echo'</span><span class="pas-sym">,</span><span class="pas-ident">bEcho</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-comment">//ablegen</span>

<span class="pas-space">    </span><span class="pas-comment">{setzt ein Flag zum Speichern und</span>
<span class="pas-comment">    erzeugt eine SettingsChanged-Message}</span>
<span class="pas-space">    </span><span class="pas-ident">settingschanged</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">{ab hier kommt erst die Logik in ausgelagerten Funktionen</span>
<span class="pas-comment">alternativ k&#246;nnen auch aus anderen Programmen bereits vorhandene Funktionen in</span>
<span class="pas-comment">eigenen Units verwendet werden (refactoring)</span>
<span class="pas-comment">}</span>
<span class="pas-comment">//---Implementation privater Modulfunctionen (Logik)</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">logMe</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-comment">//implementiert Logger-Funktion-&gt;schreibt in eine Textdatei alle Aufrufe</span>
<span class="pas-kwd">var</span><span class="pas-space"> </span><span class="pas-ident">log</span><span class="pas-sym">:</span><span class="pas-ident">TextFile</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">fname</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'LogMe entered...'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space"> </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space"> </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'LogMe'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//property Logfile abfragen</span>
<span class="pas-space"> </span><span class="pas-ident">fname</span><span class="pas-sym">:=</span><span class="pas-ident">GetProperty</span><span class="pas-sym">(</span><span class="pas-str">'LogFile'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-comment">//kein Name=nichts loggen</span>
<span class="pas-space"> </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">fname</span><span class="pas-sym">&gt;</span><span class="pas-str">''</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-comment">//file&#246;ffenen( Anh&#228;ngen oder neu)</span>
<span class="pas-space">  </span><span class="pas-ident">assignfile</span><span class="pas-sym">(</span><span class="pas-ident">log</span><span class="pas-sym">,</span><span class="pas-ident">fname</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">fileexists</span><span class="pas-sym">(</span><span class="pas-ident">fname</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">then</span><span class="pas-space"> </span><span class="pas-ident">append</span><span class="pas-sym">(</span><span class="pas-ident">log</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">else</span><span class="pas-space"> </span><span class="pas-ident">rewrite</span><span class="pas-sym">(</span><span class="pas-ident">log</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-comment">//schreiben&#180;, dabei exceptions abfangen</span>
<span class="pas-space">  </span><span class="pas-kwd">try</span>
<span class="pas-space">    </span><span class="pas-ident">writeln</span><span class="pas-sym">(</span><span class="pas-ident">log</span><span class="pas-sym">,</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">finally</span>
<span class="pas-space">  </span><span class="pas-comment">//file schliessen</span>
<span class="pas-space">  </span><span class="pas-ident">closefile</span><span class="pas-sym">(</span><span class="pas-ident">log</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space"> </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'LogMe'</span><span class="pas-sym">,</span><span class="pas-str">'finished'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">HandleData</span><span class="pas-sym">(</span><span class="pas-ident">From</span><span class="pas-sym">,</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-comment">//Verarbeitet die  ankommenden Daten in einer gemeinasmen Methode f&#252;r alle Quellen</span>
<span class="pas-kwd">var</span><span class="pas-space"> </span><span class="pas-ident">s</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">   </span><span class="pas-comment">//Nur zur Demo!! Eintrag im Kernellog zum Nachvollzienen der Aufrufe</span>
<span class="pas-space"> </span><span class="pas-ident">LogMessage</span><span class="pas-sym">(</span><span class="pas-ident">KL_DEBUG</span><span class="pas-sym">,</span><span class="pas-str">'Handle Data entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-comment">//sendData erzeugt Eintrag im DebugFenster</span>
<span class="pas-space">   </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'HandleData'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-space">   </span><span class="pas-comment">//Demo-Funktion=Text zusammensetzen</span>
<span class="pas-space">   </span><span class="pas-ident">s</span><span class="pas-sym">:=</span><span class="pas-ident">from</span><span class="pas-sym">+</span><span class="pas-str">' --&gt;'</span><span class="pas-sym">+</span><span class="pas-ident">Text</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-ident">lastline</span><span class="pas-sym">:=</span><span class="pas-ident">s</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//Text loggen</span>
<span class="pas-space">   </span><span class="pas-ident">logme</span><span class="pas-sym">(</span><span class="pas-ident">s</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//Echo zur&#252;ckgeben, wenn gefordert</span>
<span class="pas-space">   </span><span class="pas-ident">DoEcho</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-comment">//Statusvariable setzen</span>
<span class="pas-space">   </span><span class="pas-ident">fKernel</span><span class="pas-sym">.</span><span class="pas-ident">VariableManager</span><span class="pas-sym">.</span><span class="pas-ident">WriteVariableString</span><span class="pas-sym">(</span><span class="pas-ident">GetStatusVariableID</span><span class="pas-sym">(</span><span class="pas-str">'LastLineVariable'</span><span class="pas-sym">)</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">s</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'HandleData'</span><span class="pas-sym">,</span><span class="pas-str">'finished'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-comment">//------------------------------------------------------------------------------</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">DoEcho</span><span class="pas-sym">(</span><span class="pas-ident">Text</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-comment">{</span>
<span class="pas-comment">implementiert PseudoEcho-Funktion  gem&#228;&#223; Wunsch in</span>
<span class="pas-comment">http://www.ip-symcon.de/forum/f13/beispielprojekt-doku-source-veroeffentlicht-7605/index2.html#post66603</span>
<span class="pas-comment">-&gt;sendet den hereinkommenden Text an den angeschlossenen Parent zur&#252;ck, soweit dieser das unterst&#252;tzt.</span>
<span class="pas-comment">}</span>
<span class="pas-kwd">var</span><span class="pas-space"> </span><span class="pas-ident">s</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">parent</span><span class="pas-sym">:</span><span class="pas-ident">IIPSModule</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ifsend</span><span class="pas-sym">:</span><span class="pas-ident">IIPSSendString</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">s</span><span class="pas-sym">:=</span><span class="pas-ident">Text</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'entered'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-comment">//test, ob echo property gesetzt ist</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">GetProperty</span><span class="pas-sym">(</span><span class="pas-str">'Echo'</span><span class="pas-sym">)</span><span class="pas-sym">=</span><span class="pas-ident">true</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'Echo requested'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-comment">//Parent Instance holen</span>
<span class="pas-space">      </span><span class="pas-ident">parent</span><span class="pas-sym">:=</span><span class="pas-ident">getParent</span><span class="pas-sym">(</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-comment">//Test ob Instance existiert</span>
<span class="pas-space">      </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">parent</span><span class="pas-sym">=</span><span class="pas-kwd">NIL</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">      </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-comment">//nein-&gt;Melden</span>
<span class="pas-space">        </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'Kein Parent verbunden, skip'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-kwd">end</span><span class="pas-space"> </span><span class="pas-kwd">else</span><span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-comment">//test ob IIPSSendString-Interface existiert</span>
<span class="pas-space">        </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">supports</span><span class="pas-sym">(</span><span class="pas-ident">parent</span><span class="pas-sym">,</span><span class="pas-ident">IIPSSendString</span><span class="pas-sym">,</span><span class="pas-ident">IfSend</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">        </span><span class="pas-kwd">begin</span>
<span class="pas-space">        </span><span class="pas-comment">//existiert, kann senden</span>
<span class="pas-space">          </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'Alles Ok'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">          </span><span class="pas-ident">ifsend</span><span class="pas-sym">.</span><span class="pas-ident">SendText</span><span class="pas-sym">(</span><span class="pas-ident">s</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">        </span><span class="pas-kwd">end</span><span class="pas-space"> </span><span class="pas-kwd">else</span><span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space">        </span><span class="pas-comment">//Problem mitteilen</span>
<span class="pas-space">          </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'Send String not supported'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">        </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-space"> </span><span class="pas-kwd">else</span><span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space">   </span><span class="pas-comment">//kein Echo, weil nicht aktiviert, mache Debug-Eintrag</span>
<span class="pas-space">     </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'Echo not requested'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'DoEcho'</span><span class="pas-sym">,</span><span class="pas-str">'finished'</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TIPSDevice</span><span class="pas-sym">.</span><span class="pas-ident">TestFunction</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-kwd">var</span>
<span class="pas-space">  </span><span class="pas-ident">i</span><span class="pas-sym">:</span><span class="pas-ident">integer</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">msg</span><span class="pas-sym">:</span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-kwd">for</span><span class="pas-space"> </span><span class="pas-ident">I</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-num">0</span><span class="pas-space"> </span><span class="pas-kwd">to</span><span class="pas-space"> </span><span class="pas-num">99</span><span class="pas-space"> </span><span class="pas-kwd">do</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">     </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'TestFunction'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'Prepare String, Idx='</span><span class="pas-sym">+</span><span class="pas-ident">IntToStr</span><span class="pas-sym">(</span><span class="pas-ident">i</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">     </span><span class="pas-ident">msg</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">msg</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-str">'1234567890'</span><span class="pas-sym">;</span>
<span class="pas-space">     </span><span class="pas-ident">senddata</span><span class="pas-sym">(</span><span class="pas-str">'TestFunction'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'Write Variable, Idx='</span><span class="pas-sym">+</span><span class="pas-ident">IntToStr</span><span class="pas-sym">(</span><span class="pas-ident">i</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">     </span><span class="pas-ident">fKernel</span><span class="pas-sym">.</span><span class="pas-ident">VariableManager</span><span class="pas-sym">.</span><span class="pas-ident">WriteVariableString</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-ident">GetStatusVariableID</span><span class="pas-sym">(</span><span class="pas-str">'TestVariable'</span><span class="pas-sym">)</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">msg</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">.</span></pre>
